# Лабораторная работа 4: Исследование аллокаторов памяти

## Описание

Программа исследует два аллокатора памяти: аллокатор на основе списков свободных блоков (first-fit) и аллокатор в стиле Мак-Кьюзи-Кэрелса (buddy allocator с size classes). Аллокаторы реализованы как динамические библиотеки, загружаемые во время выполнения. Проводится тестирование по характеристикам: фактор использования, скорость выделения и освобождения блоков, простота использования.

## Сборка

В каталоге `lab4` выполните:

```bash
make
```

Создаются:
- `src/driver` — программа для тестирования.
- `alloc_free_list.so` — библиотека с first-fit free list аллокатором.
- `alloc_mc_kusick.so` — библиотека с buddy аллокатором.

## Запуск

### Тестирование

```bash
./src/driver [lib_path] [arena_size] [num_allocs]
```

- `lib_path`: путь к библиотеке (опционально, по умолчанию fallback на mmap).
- `arena_size`: размер арены в байтах (по умолчанию 1 MiB).
- `num_allocs`: количество аллокаций (по умолчанию 100000).

Примеры:
- `./src/driver` — fallback.
- `./src/driver ./alloc_free_list.so 1048576 10000` — free list с 1 MiB, 10000 аллокаций.
- `./src/driver ./alloc_mc_kusick.so` — buddy.

Вывод: время на аллокации и освобождения, среднее время на операцию.

## Алгоритмы

### 1. Списки свободных блоков (first-fit)

- **Описание**: Память разделена на блоки с заголовками (size, next, free). Свободные блоки в односвязном списке. Аллокация: поиск первого подходящего блока (>= нужный размер), разделение если возможно, маркировка занятым. Освобождение: маркировка свободным, вставка в начало списка, попытка слияния с соседним свободным блоком.
- **Преимущества**: Простота, хорошая локальность.
- **Недостатки**: Фрагментация, линейный поиск (O(n) в худшем случае).
- **Фактор использования**: Зависит от паттерна аллокаций, может быть низким из-за внешней фрагментации.
- **Скорость**: Аллокация медленнее при большом списке, освобождение быстрое.

### 2. Алгоритм Мак-Кьюзи-Кэрелса (buddy allocator)

- **Описание**: Память разделена на блоки степеней двойки (size classes). Свободные блоки в отдельных списках по размерам. Аллокация: найти минимальный подходящий класс, разделить больший блок на buddies если нужно. Освобождение: попытка слияния с buddy (если свободен), повышение класса.
- **Преимущества**: Быстрое слияние, низкая фрагментация, O(log N) операции.
- **Недостатки**: Внутренняя фрагментация (блок большего размера), сложнее.
- **Фактор использования**: Выше, меньше внешней фрагментации.
- **Скорость**: Быстрее аллокация и освобождение.

## Тестирование

- **Подход**: Случайные размеры блоков (8-4096 байт), многократные аллокации/освобождения. Измерение времени с clock_gettime. Фактор использования: (сумма выделенных размеров) / arena_size.
- **Обоснование**: Случайные размеры моделируют реальные нагрузки. Большое N для точности, усреднение. Минимизация накладных расходов: измерение только аллокаций, без вывода.
- **Результаты**: Пример (1 MiB, 100000 аллокаций):
  - Fallback (mmap): alloc_ms=709, free_ms=551, per_alloc_ns=7093, per_free_ns=5507.
  - Free list: (предположительно медленнее, больше фрагментации).
  - Buddy: alloc_ms=0.5, free_ms=0.8, per_alloc_ns=5, per_free_ns=8 (быстрее, но может исчерпать память при большом N).

## Структура кода

- `include/allocator_api.h`: интерфейс аллокаторов.
- `alloc_free_list/`: first-fit реализация.
- `alloc_mc_kusick/`: buddy реализация.
- `src/driver.c`: загрузка библиотек, тестирование.
- `Makefile`: сборка.

## Зависимости

- Linux, gcc, dlfcn, mmap.
